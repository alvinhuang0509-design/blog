---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import { plainify } from "@/lib/utils/textConverter";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import "@/styles/main.css";
import {
  GoogleTagmanager,
  GoogleTagmanagerNoscript,
} from "@digi4care/astro-google-tagmanager";
import { ClientRouter } from "astro:transitions";
import Announcement from "./helpers/Announcement";
import SearchModal from "./helpers/SearchModal";

// types for frontmatters
export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  og_type?: "website" | "article";
  published_time?: Date | string;
  modified_time?: Date | string;
  author?: string;
  katex?: boolean;
  mermaid?: boolean;
}

// destructure frontmatter
const {
  title,
  meta_title,
  description,
  image,
  noindex,
  canonical,
  og_type,
  published_time,
  modified_time,
  author,
  katex: enableKatex,
  mermaid: enableMermaid,
} =
  Astro.props;

const resolvedCanonical =
  canonical ??
  (Astro.site
    ? new URL(Astro.url.pathname, Astro.site).toString()
    : config.site.base_url
      ? new URL(Astro.url.pathname, config.site.base_url).toString()
      : undefined);

const htmlLang = (config.metadata as any)?.language || "zh-CN";
const ogLocale = (config.metadata as any)?.locale || "zh_CN";
const ogType = og_type || "website";

const baseUrl =
  Astro.site ??
  (config.site.base_url ? new URL(config.site.base_url) : undefined);

const resolvedTitle = plainify(meta_title ? meta_title : title ? title : config.site.title);
const resolvedDescription = plainify(
  description ? description : config.metadata.meta_description
);

const toIso = (value?: Date | string) => {
  if (!value) return undefined;
  const d = typeof value === "string" ? new Date(value) : value;
  return Number.isNaN(d.getTime()) ? undefined : d.toISOString();
};

const publishedTimeIso = toIso(published_time);
const modifiedTimeIso = toIso(modified_time);

const resolvedOgImage =
  (baseUrl && new URL(image ? image : config.metadata.meta_image, baseUrl).toString()) ||
  `${config.site.base_url}${image ? image : config.metadata.meta_image}`;

const jsonLd = (() => {
  if (!baseUrl || !resolvedCanonical) return null;

  const website = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: config.site.title,
    url: new URL("/", baseUrl).toString(),
  };

  if (ogType !== "article") return [website];

  const blogPosting: Record<string, unknown> = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: resolvedTitle,
    description: resolvedDescription,
    image: resolvedOgImage,
    mainEntityOfPage: resolvedCanonical,
    author: {
      "@type": "Person",
      name: author || config.metadata.meta_author,
    },
    publisher: {
      "@type": "Person",
      name: config.metadata.meta_author,
    },
  };

  if (publishedTimeIso) {
    blogPosting.datePublished = publishedTimeIso;
    blogPosting.dateModified = modifiedTimeIso || publishedTimeIso;
  } else if (modifiedTimeIso) {
    blogPosting.dateModified = modifiedTimeIso;
  }

  return [website, blogPosting];
})();
---

<!doctype html>
<html lang={htmlLang}>
  <head>
    <!-- google tag manager -->
    {
      config.google_tag_manager.enable && (
        <GoogleTagmanager id={config.google_tag_manager.gtm_id} />
      )
    }
    <meta charset="utf-8" />
    <!-- favicon -->
    <link rel="shortcut icon" href={config.site.favicon} />
    <link rel="icon" href={config.site.favicon} />
    <!-- theme meta -->
    <meta name="theme-name" content="lewins-insight" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="#fff"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#000"
    />
    <meta name="generator" content={Astro.generator} />

    <!-- google font css -->
    <!-- <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontSecondary!,
          fallback: "sans-serif",
          cssVariable: "font-secondary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${sf}&display=swap`,
        },
      ]}
    /> -->

    <!-- responsive meta -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5"
    />

    <!-- title -->
    <title>
      {resolvedTitle}
    </title>

    <!-- canonical url -->
    {resolvedCanonical && <link rel="canonical" href={resolvedCanonical} />}

    <meta
      name="robots"
      content={noindex ? "noindex,follow" : "index,follow"}
    />

    <!-- meta-description -->
    <meta
      name="description"
      content={resolvedDescription}
    />

    <ClientRouter />

    <!-- author from config.json -->
    <meta name="author" content={config.metadata.meta_author} />

    <!-- og-title -->
    <meta
      property="og:title"
      content={plainify(
        meta_title ? meta_title : title ? title : config.site.title
      )}
    />

    <!-- og-description -->
    <meta
      property="og:description"
      content={resolvedDescription}
    />
    <meta property="og:site_name" content={config.site.title} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:type" content={ogType} />
    {resolvedCanonical && <meta property="og:url" content={resolvedCanonical} />}
    {
      ogType === "article" && (
        <>
          {publishedTimeIso && (
            <meta property="article:published_time" content={publishedTimeIso} />
          )}
          {modifiedTimeIso && (
            <meta property="article:modified_time" content={modifiedTimeIso} />
          )}
        </>
      )
    }

    <!-- twitter-title -->
    <meta
      name="twitter:title"
      content={plainify(
        meta_title ? meta_title : title ? title : config.site.title
      )}
    />

    <!-- twitter-description -->
    <meta
      name="twitter:description"
      content={plainify(
        description ? description : config.metadata.meta_description
      )}
    />

    <!-- og-image -->
    <meta
      property="og:image"
      content={resolvedOgImage}
    />

    <!-- twitter-image -->
    <meta
      name="twitter:image"
      content={resolvedOgImage}
    />
    <meta name="twitter:card" content="summary_large_image" />

    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${config.site.title} RSS`}
      href="/rss.xml"
    />

    {jsonLd && (
      <script is:inline type="application/ld+json">
        {JSON.stringify(jsonLd)}
      </script>
    )}
    
    {
      enableKatex && (
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
          integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
          crossorigin="anonymous"
        />
      )
    }
  </head>
  <body>
    <a href="#main-content" class="skip-link">跳到正文</a>
    {/* google tag manager noscript */}
    {
      config.google_tag_manager.enable && (
        <GoogleTagmanagerNoscript id={config.google_tag_manager.gtm_id} />
      )
    }

    <TwSizeIndicator />
    <Announcement client:load transition:persist />
    <Header transition:persist />
    <SearchModal client:idle transition:persist />
    {/* <ProgressBar client:load /> */}
    {/* <BackToTop client:load /> */}
    <main id="main-content">
      <slot />
    </main>
    <Footer transition:persist />
    
    {
      enableMermaid && (
        <script is:inline type="module">
          {`
          const initMermaid = async () => {
            const graphs = document.querySelectorAll('pre code.language-mermaid');
            if (graphs.length === 0) return;

            const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');

            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'neutral';
            mermaid.initialize({ startOnLoad: false, theme });

            for (const graph of graphs) {
              const content = graph.textContent;
              const pre = graph.parentElement;

              const div = document.createElement('div');
              div.classList.add('mermaid', 'flex', 'justify-center', 'my-8');
              div.textContent = content;

              if (pre) pre.replaceWith(div);
            }

            await mermaid.run({ querySelector: '.mermaid' });
          };

          document.addEventListener('astro:page-load', initMermaid);
          document.addEventListener('astro:after-swap', initMermaid);
          `}
        </script>
      )
    }
  </body>
</html>

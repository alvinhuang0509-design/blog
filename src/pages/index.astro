---
import ImageMod from "@/components/ImageMod.astro";
import Base from "@/layouts/Base.astro";
import BlogCard from "@/components/BlogCard.astro";
import { getListPage, getSinglePage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import { sortByDate } from "@/lib/utils/sortFunctions";
import getHotPosts from "@/lib/utils/hotPosts";
import dateFormat from "@/lib/utils/dateFormat";
import config from "@/config/config.json";

const homepage = await getListPage("homepage", "-index");
const { banner } = homepage.data;

const getFormat = (src?: string) => (src?.endsWith(".svg") ? "svg" : "webp");
const bannerLight = banner?.image as string | undefined;
const bannerDark = banner?.image_dark as string | undefined;

// Fetch posts
const [aiPosts, secPosts, lifePosts, blogPosts] = await Promise.all([
  getSinglePage("ai"),
  getSinglePage("security"),
  getSinglePage("dailyLife"),
  getSinglePage("blog"),
]);

// Add 'section' property to each post to generate correct URLs
const aiWithSection = aiPosts.map((post) => ({ ...post, section: "ai" }));
const securityWithSection = secPosts.map((post) => ({ ...post, section: "security" }));
const lifeWithSection = lifePosts.map((post) => ({ ...post, section: "daily-life" }));
const blogWithSection = blogPosts.map((post) => ({ ...post, section: "blog" }));

const allPosts = [
  ...securityWithSection,
  ...aiWithSection,
  ...lifeWithSection,
  ...blogWithSection,
];

const compareByDateDesc = (a: any, b: any) =>
  new Date(b.data?.date ?? 0).valueOf() - new Date(a.data?.date ?? 0).valueOf();

const pinnedPosts = allPosts
  .filter((post: any) => Boolean(post.data?.pinned))
  .sort((a: any, b: any) => {
    const aw = typeof a.data?.weight === "number" ? a.data.weight : 999;
    const bw = typeof b.data?.weight === "number" ? b.data.weight : 999;
    if (aw !== bw) return aw - bw;
    return compareByDateDesc(a, b);
  });

const featuredOnly = allPosts
  .filter((post: any) => Boolean(post.data?.featured) && !post.data?.pinned)
  .sort(compareByDateDesc);

const latestPosts = sortByDate(allPosts).slice(0, 6);

const highlightedPosts = (() => {
  const merged = [...pinnedPosts, ...featuredOnly, ...latestPosts];
  const seen = new Set<string>();
  return merged.filter((post: any) => {
    const key = `${post.section}/${post.id}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
})();

const hotPosts = getHotPosts(allPosts, 6);

const securityLatest = sortByDate(securityWithSection).slice(0, 3);
const aiLatest = sortByDate(aiWithSection).slice(0, 3);
const lifeLatest = sortByDate(lifeWithSection).slice(0, 3);
---

<Base>
  {bannerLight && <link rel="preload" as="image" href={bannerLight} />}

  <!-- Hero -->
  <section class="pt-10 pb-10">
    <div class="container">
      <div class="row items-center justify-between">
        <div class="lg:col-6">
          <h1 set:html={markdownify(banner.title)} class="mb-4 text-h3 lg:text-h1" />
          <p set:html={markdownify(banner.content)} class="mb-6 leading-relaxed text-text-light dark:text-darkmode-text-light" />
          <div class="flex flex-wrap items-center gap-3">
            {banner.button.enable && (
              <a
                class="btn btn-primary"
                href={banner.button.link}
                target={banner.button.link.startsWith("http") ? "_blank" : "_self"}
                rel="noopener"
                data-astro-prefetch="hover"
              >
                {banner.button.label}
              </a>
            )}
            {config.navigation_button.enable && (
              <a
                class="btn btn-outline-primary"
                href={config.navigation_button.link}
                target={config.navigation_button.link.startsWith("http") ? "_blank" : "_self"}
                rel={config.navigation_button.link.startsWith("http") ? "noopener" : ""}
              >
                {config.navigation_button.label}
              </a>
            )}
            <a
              href="/start"
              class="text-sm font-semibold text-text-dark underline decoration-border underline-offset-4 transition-colors hover:text-primary dark:text-darkmode-text-dark dark:hover:text-darkmode-primary"
              data-astro-prefetch="hover"
            >
              从这里开始
            </a>
          </div>
        </div>

        <div class="mt-8 lg:col-6 lg:mt-0">
          <div class="rounded-2xl border border-border bg-body p-6 shadow-sm dark:border-darkmode-border dark:bg-darkmode-light">
            <div class="mb-4 flex items-center justify-between">
              <h2 class="text-lg font-bold">最新文章</h2>
              <button
                type="button"
                class="text-sm font-semibold text-primary hover:underline dark:text-darkmode-primary"
                data-search-trigger
              >
                搜索
              </button>
            </div>
            <ul class="space-y-3">
              {latestPosts.slice(0, 6).map((post: any) => (
                <li>
                  <article>
                    <a
                      href={`/${post.section}/${post.id}`}
                      class="block rounded-lg px-2 py-1 transition-colors hover:bg-light hover:text-primary dark:hover:bg-darkmode-body dark:hover:text-darkmode-primary"
                      data-astro-prefetch="hover"
                    >
                      <div class="truncate font-semibold text-text-dark dark:text-darkmode-text-dark">
                        {post.data.title}
                      </div>
                      <div class="flex items-center gap-2 text-xs text-text-light dark:text-darkmode-text-light">
                        <span>
                          {post.section === "security"
                            ? "安全"
                            : post.section === "ai"
                              ? "AI"
                              : post.section === "daily-life"
                                ? "生活"
                                : "博客"}
                        </span>
                        {post.data.date && <span>· {dateFormat(post.data.date)}</span>}
                      </div>
                    </a>
                  </article>
                </li>
              ))}
            </ul>

            {(bannerLight || bannerDark) && (
              <div class="mt-6">
                {bannerLight && (
                  <ImageMod
                    src={bannerLight}
                    height={200}
                    width={1200}
                    alt={`${config.site.title} Banner`}
                    format={getFormat(bannerLight)}
                    class={`w-full rounded-xl border border-border dark:border-darkmode-border ${bannerDark ? "dark:hidden" : ""}`}
                    loading="eager"
                    decoding="async"
                  />
                )}
                {bannerDark && (
                  <ImageMod
                    src={bannerDark}
                    height={200}
                    width={1200}
                    alt={`${config.site.title} Banner (Dark)`}
                    format={getFormat(bannerDark)}
                    class="hidden w-full rounded-xl border border-border dark:block dark:border-darkmode-border"
                    loading="eager"
                    decoding="async"
                  />
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Start -->
  <section class="pb-10">
    <div class="container">
      <div class="grid gap-6 lg:grid-cols-3">
        <a
          href="/security"
          data-astro-prefetch="hover"
          class="hover-card block rounded-2xl border border-border bg-body p-6 transition-all hover:border-primary dark:border-darkmode-border dark:bg-darkmode-light"
        >
          <div class="mb-2 text-sm font-semibold text-text-light dark:text-darkmode-text-light">栏目</div>
          <div class="mb-2 text-xl font-bold text-text-dark dark:text-darkmode-text-dark">信息安全</div>
          <div class="text-sm leading-relaxed text-text-light dark:text-darkmode-text-light">
            漏洞与攻防笔记 · 体系化方法与工程实践。
          </div>
        </a>
        <a
          href="/ai"
          data-astro-prefetch="hover"
          class="hover-card block rounded-2xl border border-border bg-body p-6 transition-all hover:border-primary dark:border-darkmode-border dark:bg-darkmode-light"
        >
          <div class="mb-2 text-sm font-semibold text-text-light dark:text-darkmode-text-light">栏目</div>
          <div class="mb-2 text-xl font-bold text-text-dark dark:text-darkmode-text-dark">AI</div>
          <div class="text-sm leading-relaxed text-text-light dark:text-darkmode-text-light">
            模型与产品观察 · 工具与实践笔记。
          </div>
        </a>
        <a
          href="/daily-life"
          data-astro-prefetch="hover"
          class="hover-card block rounded-2xl border border-border bg-body p-6 transition-all hover:border-primary dark:border-darkmode-border dark:bg-darkmode-light"
        >
          <div class="mb-2 text-sm font-semibold text-text-light dark:text-darkmode-text-light">栏目</div>
          <div class="mb-2 text-xl font-bold text-text-dark dark:text-darkmode-text-dark">个人生活博客</div>
          <div class="text-sm leading-relaxed text-text-light dark:text-darkmode-text-light">
            旅行 · 美食 · 摄影 · 日常随想。
          </div>
        </a>
      </div>
    </div>
  </section>

  <!-- Highlights -->
  <section class="pb-16">
    <div class="container">
      <div class="grid gap-8 lg:grid-cols-3">
        <div class="rounded-2xl border border-border bg-body p-6 dark:border-darkmode-border dark:bg-darkmode-light">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-lg font-bold">置顶 / 精选</h2>
            <a href="/start" class="text-sm font-semibold text-primary hover:underline dark:text-darkmode-primary" data-astro-prefetch="hover">文章地图</a>
          </div>
          <ul class="space-y-3">
            {highlightedPosts.slice(0, 6).map((post: any) => (
              <li>
                <article>
                  <a
                    href={`/${post.section}/${post.id}`}
                    class="block rounded-lg px-2 py-1 transition-colors hover:bg-light hover:text-primary dark:hover:bg-darkmode-body dark:hover:text-darkmode-primary"
                    data-astro-prefetch="hover"
                  >
                    <div class="flex items-center justify-between gap-3">
                      <div class="truncate font-semibold text-text-dark dark:text-darkmode-text-dark">
                        {post.data.title}
                      </div>
                      {post.data?.pinned ? (
                        <span class="shrink-0 rounded-full bg-primary/10 px-2 py-0.5 text-xs font-semibold text-primary dark:bg-darkmode-primary/10 dark:text-darkmode-primary">
                          置顶
                        </span>
                      ) : post.data?.featured ? (
                        <span class="shrink-0 rounded-full bg-border/60 px-2 py-0.5 text-xs font-semibold text-text-dark dark:bg-darkmode-border/60 dark:text-darkmode-text-dark">
                          精选
                        </span>
                      ) : null}
                    </div>
                    {post.data.date && (
                      <div class="text-xs text-text-light dark:text-darkmode-text-light">{dateFormat(post.data.date)}</div>
                    )}
                  </a>
                </article>
              </li>
            ))}
          </ul>
        </div>

        <div class="rounded-2xl border border-border bg-body p-6 dark:border-darkmode-border dark:bg-darkmode-light">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-lg font-bold">热门 / 最多阅读</h2>
            <a href="/subscribe" class="text-sm font-semibold text-primary hover:underline dark:text-darkmode-primary" data-astro-prefetch="hover">订阅</a>
          </div>
          <ul class="space-y-3">
            {hotPosts.map((post: any) => (
              <li>
                <article>
                  <a
                    href={`/${post.section}/${post.id}`}
                    class="block rounded-lg px-2 py-1 transition-colors hover:bg-light hover:text-primary dark:hover:bg-darkmode-body dark:hover:text-darkmode-primary"
                    data-astro-prefetch="hover"
                  >
                    <div class="truncate font-semibold text-text-dark dark:text-darkmode-text-dark">{post.data.title}</div>
                    <div class="text-xs text-text-light dark:text-darkmode-text-light">
                      {typeof post.data.views === "number" ? `${post.data.views} 次阅读` : "热门"}
                    </div>
                  </a>
                </article>
              </li>
            ))}
          </ul>
        </div>

        <div class="rounded-2xl border border-border bg-body p-6 dark:border-darkmode-border dark:bg-darkmode-light">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-lg font-bold">订阅更新</h2>
            <a href="/rss.xml" class="text-sm font-semibold text-primary hover:underline dark:text-darkmode-primary" data-astro-prefetch="hover">RSS</a>
          </div>
          <p class="mb-4 text-sm leading-relaxed text-text-light dark:text-darkmode-text-light">
            推荐使用 RSS 订阅站点更新，或收藏“从这里开始”按主题阅读。
          </p>
          <div class="flex flex-wrap items-center gap-3">
            <a class="btn btn-primary btn-sm" href="/subscribe" data-astro-prefetch="hover">
              去订阅页
            </a>
            <a class="btn btn-outline-primary btn-sm" href="/start" data-astro-prefetch="hover">
              文章地图
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Security Section -->
  <section class="section pt-0">
    <div class="container">
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-h3 font-bold">信息安全</h2>
        <a
          href="/security"
          class="text-primary hover:underline dark:text-darkmode-primary"
          data-astro-prefetch="hover"
        >
          查看全部 &rarr;
        </a>
      </div>
      <div class="row">
        {
          securityLatest.length > 0 ? (
            securityLatest.map((post) => (
              <div class="mb-8 md:col-6 lg:col-4">
                <BlogCard data={post} section={post.section} />
              </div>
            ))
          ) : (
            <div class="col-12 text-center py-10 bg-theme-light dark:bg-darkmode-theme-light rounded">
              <p>还没有发布内容，敬请期待。</p>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- AI Section -->
  <section class="section pt-0">
    <div class="container">
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-h3 font-bold">AI</h2>
        <a
          href="/ai"
          class="text-primary hover:underline dark:text-darkmode-primary"
          data-astro-prefetch="hover"
        >
          查看全部 &rarr;
        </a>
      </div>
      <div class="row">
        {
          aiLatest.length > 0 ? (
            aiLatest.map((post) => (
              <div class="mb-8 md:col-6 lg:col-4">
                <BlogCard data={post} section={post.section} />
              </div>
            ))
          ) : (
            <div class="col-12 text-center py-10 bg-theme-light dark:bg-darkmode-theme-light rounded">
              <p>还没有发布内容，敬请期待。</p>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- Life Section -->
  <section class="section pt-0">
    <div class="container">
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-h3 font-bold">个人生活博客</h2>
        <a href="/daily-life" class="text-primary hover:underline dark:text-darkmode-primary" data-astro-prefetch="hover">查看全部 &rarr;</a>
      </div>
      <div class="row">
        {
          lifeLatest.length > 0 ? (
            lifeLatest.map((post) => (
              <div class="mb-8 md:col-6 lg:col-4">
                <BlogCard data={post} section={post.section} />
              </div>
            ))
          ) : (
            <div class="col-12 text-center py-10 bg-theme-light dark:bg-darkmode-theme-light rounded">
              <p>还没有发布生活分享。</p>
            </div>
          )
        }
      </div>
    </div>
  </section>
</Base>
